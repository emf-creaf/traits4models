---
title: "Building species parameter tables for medfate"
author: "Miquel De CÃ¡ceres / Nicolas Martin-StPaul"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: TRUE
bibliography: traits4models.bib
params:
  spparams_rebuild: FALSE
  IFN_rebuild: FALSE
---

## Introduction

### Aim

This vignette describes the procedures used to obtain the species parameter data tables (such as `SpParamsES`, `SpParamsFR` and `SpParamsUS` included in package **traits4models**). Each species parameter table is meant to be used on forest plot locations belonging to a given National Forest Inventory (NFI). Hence, the taxon entities chosen (rows in `SpParams`) are intended to represent plant taxa reported in the NFI. 

>**IMPORTANT**: The vignette is not self-contained, in the sense that it cannot be reproduced without access to data sets that are not included. Nevertheless, it is intended to serve as example of species parameterization for other regions.

### Required packages

Installed version of **medfate** should be **ver 4.3.1** or higher. 
```{r, eval = FALSE}
install.packages("medfate")
```

Package **traits4models** is required for the species parameterization process, as it includes several functions that facilitate parsing data sources into parameter values. Package **traits4models** is installed only from GitHub:

```{r, eval = FALSE}
remotes::install_github("emf-creaf/traits4models")
```

Package **medfuels** is also needed because it includes allometric coefficients for Mediterranean shrub species. As before, package **medfuels** is installed only from GitHub:

```{r, eval = FALSE}
remotes::install_github("spif-ctfc/medfuels")
```

Once we have **medfate**, **traits4models** and  **medfuels**, we load them and other common packages that we will employ in this vignette:
```{r message=FALSE}
library(medfate)
library(traits4models)
library(medfuels)
# library(IFNread)
library(tidyverse)
library(openxlsx)
```

### Target parameters

The set of species parameters needed to run the models included in **medfate** are described in a dataframe called `SpParamsDefinition`. It is obvious that **medfate** requires a sheer number of parameters cannot be searched for manually, even for a small number of target species. Hence, it is important to draw values from allometric and plant trait data bases. Not all model parameters have their counterpart in publicly-available databases, and even when using data bases it is unlikely that one will find appropriate parameter values for all species. To help with this situation, **medfate** has *inbuilt imputation procedures* to estimate missing values for many parameters before starting model simulations. However, imputed parameter estimates will normally be worse than estimates coming from data bases. Hence, we should put a strong effort in finding source parameter data before relying on inbuilt imputation.

### Steps to build a species parameter table

The following sections describe different steps that we used to obtain the species parameter table, which can be grouped into four main tasks:

 1. Initialize the parameter table with target taxonomic entities.
 2. Draw species parameters from forest inventory (IFN in our case) data.
 3. Populate tree and shrub allometric coefficients from suitable allometric databases.
 4. Populate plant functional traits from available data bases
 
## Initializing a species parameter table

### Target taxonomic entities

The species parameter table for **medfate** starts with a vector of species names. Here, we will assume that those names correspond to taxa mentioned in a national forest inventory, more specifically the Spanish National Forest Inventory (SFI). Note that taxon entities in a forest inventory will refer to their own taxonomic reference. Hence, it is important to harmonize taxonomy with the reference used in **traits4models**, i.e. [World Flora Online](https://www.worldfloraonline.org/). Here we will assume that such harmonization has been conducted for the SFI taxon list:

```{r}
data("NFI_SP_mapping") 
NFI_SP_mapping
```

Here `NFIName` corresponds to the name used in the forest inventory, while `originalName` has the same value if `NFIName` corresponds to a scientific taxon, otherwise is missing. Therefore, we can filter non-scientific taxon names using:

```{r}
# Filter entities not recognized
spp_filt <- NFI_SP_mapping |>
  dplyr::filter(!is.na(originalName)) |>
  dplyr::select(NFIName, acceptedName) |>
  unique()
```

`NFIName` is kept to match the names used in forest inventory data, while `acceptedName` will be used to ensure that matching with trait information is done using the appropriate (harmonized) taxonomic nomenclature.

### Initialization

Package **traits4models** provides function `init_spparams()` to initialize a species parameter table according to a given set of taxon names. Here we call the function with both `NFIName` and `acceptedName`.

```{r, eval = FALSE}
SpParams <- traits4models::init_spparams(sp_names = spp_filt$NFIName,
                                         accepted_names = spp_filt$acceptedName,
                                         verbose = FALSE)
```

```{r, echo = FALSE}
SpParams <- readRDS("SpParams_init_sp.rds")
```

The result is an empty data frame, except for the first columns, which correspond to taxonomic hierarchy of each entity (genus, family, group, ...). 

```{r}
SpParams |> tibble::as_tibble()
```

Taxonomic entities above species are obtained from accepted names using package **taxize**.

## Drawing structural parameters from forest inventory data

## Filling parameters from harmonized trait databases

```{r}
harmonized_trait_path <- "~/OneDrive/EMF_datasets/PlantTraitDatabases/Products/harmonized"
```

```{r}
trait_tables <- traits4models::load_harmonized_tables(harmonized_trait_path, progress = FALSE)
length(trait_tables)
```


```{r}
SpParams_filled<- traits4models::fill_traits(SpParams, harmonized_trait_path, 
                                             progress = FALSE, verbose = FALSE)
```

## Completing strict parameters

```{r}
# SpParams <- traits4models::complete_strict(SpParams)
```


## Filling allometric coefficients

## Checking species parameter tables

## References
