---
title: "Allometry database harmonization"
author: "Miquel De Cáceres / Nicolas Martin-StPaul"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: TRUE
bibliography: traits4models.bib
params:
  spparams_rebuild: FALSE
  IFN_rebuild: FALSE
---

## Introduction



### Required packages

Assuming we have **traits4models** installed, we load it and other common packages that we will employ in this vignette:
```{r message=FALSE}
library(traits4models)
library(tidyverse)
library(readr)
```


### Example dataset


```{r, message=FALSE}
DB_path <- "~/OneDrive/EMF_datasets/AllometryDatabases/"
db <- openxlsx::read.xlsx(paste0(DB_path, "Sources/TreeAllometries/TreeAllometries.xlsx"),
                                 sheet= "Tree_CR_models")
```

The data looks as follows:
```{r}
db
```


## Harmonizing equations and notation

```{r}
db_var <- db |>
  dplyr::rename(originalName = "Name",
                a = "a_cr",
                b = "b_1cr",
                c = "b_2cr",
                d = "b_3cr",
                e = "c_1cr",
                f = "c_2cr",
                Reference = "Source") |>
  dplyr::mutate(Equation = "CrownRatio = 1/(1 + exp(a + b·HD + c·(H/100) + d·DBH^2 + e·BAL + f·ln(CCF)))",
                Response = "CrownRatio",
                ResponseDescription = "Crown ratio",
                Predictor1 = "HD",
                PredictorDescription1 = "Height-diameter ratio (m·m-1)",
                Predictor2 = "H",
                PredictorDescription2 = "Tree height (m)",
                Predictor3 = "DBH",
                PredictorDescription3 = "Diameter at breast height (cm)",
                Predictor4 = "BAL",
                PredictorDescription4 = "Basal area of larger trees",
                Predictor5 = "CCF",
                PredictorDescription5 = "Crown competition factor",
                Priority = 1) |>
  dplyr::relocate(Reference, .after = PredictorDescription5)
```


## Taxonomic harmonization

Package **traits4models** currently relies on [World Flora Online](https://www.worldfloraonline.org/) for taxonomic harmonization, via package **WorldFlora** [@kindt_worldflora_2020] available at [CRAN](https://cran.r-project.org/package=WorldFlora). This latter package requires a static copy of the World Flora Online Taxonomic Backbone data that can be downloaded from the [World Flora Online](https://www.worldfloraonline.org/) website. Note that you should use a different DOI reference when reporting your harmonization procedures. We are using here [v.2024.06](https://doi.org/10.5281/zenodo.7460141). We assume the user has already downloaded the backbone and stored it in a file called *classification.csv*. 

```{r}
WFO_file <- paste0(DB_path, "../PlantTraitDatabases/WFO_Backbone/classification.csv")
```

Taxonomic harmonization is done by calling function `harmonize_taxonomy_WFO()` with a data frame (where notation and units are already harmonized) and the path to the WFO backbone (we omit the console output):

```{r, eval = FALSE}
db_post <- traits4models::harmonize_taxonomy_WFO(db_var, WFO_file)
```

```{r, message= FALSE, warning=FALSE, error=FALSE, echo = FALSE, include = FALSE}
db_post <- traits4models::harmonize_taxonomy_WFO(db_var, WFO_file)
```

The function requires that the input data frame contains a column called `originalName`, to identify the original taxa names (additional columns are simply transferred to the output). It performs both direct and fuzzy matching, which may lead to large processing time for large datasets. If we inspect the resulting data frame, we will see the additional columns, informing about accepted names and parent taxonomic entities:

```{r}
head(db_post)
```

## Checking harmonized allometry data

The packages includes function `check_harmonized_allometry()` to check whether a given data frame conforms in structure and content to what is later required for parameter table filling:

```{r}
check_harmonized_allometry(db_post)
```

In this case, the data set is ready to be used in parameter estimation. As an example, we can run the same checking function with the data base before taxonomic harmonization:

```{r}
check_harmonized_allometry(db_var)
```

## Storing harmonized dataset

Harmonized data tables should be preferably stored in compressed **.rds** format. Moreover, all tables should be stored in the same directory, here in the `Products/harmonized/` path.

```{r, eval = FALSE}
write.csv2(db_post, "Products/harmonized/tree_crown_ratio_europe.csv", row.names = FALSE)
```

## Accessing harmonized allometry data

### List of harmonized allometry databases

As mentioned in the introduction, here it is assumed that a set of plant allometry databases have been harmonized. In our case, harmonized data files have been stored as **.rds** or **.csv** files in the following path:

```{r}
harmonized_allometry_path = "~/OneDrive/EMF_datasets/AllometryDatabases/Products/harmonized"
```

We can list the set of harmonized sources using:
```{r}
allometry_files <- list.files(path = harmonized_allometry_path, full.names = FALSE)
allometry_files
```

### Querying allometry data for particular response variable

Before filling any species parameter table, it may be useful to inspect the amount of information available for particular response. Package **trait4models** provides function `get_allometry_data()`:

```{r}
fb_data <- get_allometry_data(harmonized_allometry_path, "FoliarBiomass",
                           progress = FALSE)
head(fb_data)
```


## References
